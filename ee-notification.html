<link rel="import" href="../polymer/polymer.html">

<!-- Elfy -->
<link rel="import" href="../ee-shared-styles/shared-styles.html">
<link rel="import" href="../elfy-api/elfy-api.html">
<link rel="import" href="../ee-helper-behavior/ee-helper-behavior.html">

<!-- Iron -->
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../iron-dropdown/iron-dropdown.html">
<link rel="import" href="../iron-icons/social-icons.html">

<!-- Paper -->
<link rel="import" href="../paper-material/paper-material.html">

<!-- Third -->
<link rel="import" href="../polymerfire/firebase.html">
<link rel="import" href="../polymerfire/firebase-auth.html">
<link rel="import" href="../polymerfire/firebase-app.html">
<link rel="import" href="../polymerfire/firebase-query.html">

<!-- My -->
<link rel="import" href="notification-row.html">


<!--
`ee-notification`
Notification dropdown and methods

@demo demo/index.html
-->

<dom-module id="ee-notification">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }

      .dropdown-content {
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14),
                  0 1px 5px 0 rgba(0, 0, 0, 0.12),
                  0 3px 1px -2px rgba(0, 0, 0, 0.2);
        width: 100vw;
        height: 100vh;
        max-width: 320px;
        max-height: 480px;
        background-color: #fff;
      }

      .notification-list {
        width: 100%;
        height: calc(100% - 32px);
        overflow: scroll;
      }

      .dropdown-title {
        height: 31px;
        border-bottom: 1px solid #eee;
        padding: 0 8px;
      }

      #list {
        width: 100%;
      }
    </style>

    <paper-icon-button onclick="dropdown.open()" class="dropdown-trigger" icon="social:public"></paper-icon-button>
    <iron-dropdown id="dropdown" horizontal-align="right" vertical-align="top">
      <div class="dropdown-content">
        <div class="dropdown-title h-c">
          <span>Notifications</span>
        </div>
        <div class="notification-list">
          <iron-list id="list" items="[[notifications]]" as="notification">
            <template>
              <notification-row
                app="[[app]]"
                me="[[me]]"
                key="[[notification.$key]]"
                path="[[_notificationPath]]">
              </notification-row>
            </template>
          </iron-list>
        </div>
      </div>
    </iron-dropdown>

    <firebase-app
      auth-domain="[[authDomain]]"
      database-url="[[databaseUrl]]"
      api-key="[[apiKey]]"
      app="{{app}}">
    </firebase-app>

    <firebase-auth
      id="auth"
      user="{{firebaseUser}}"
      app="[[app]]"
      provider="google"
      signed-in="{{signedIn}}">
    </firebase-auth>

    <firebase-query
      id="query"
      app="[[app]]"
      path="[[_notificationPath]]"
      data="{{notifications}}"
      disabled="[[!signedIn]]"
      limit-to-first="100">
    </firebase-query>

  </template>

  <script>
    Polymer({

      is: 'ee-notification',

      properties: {

        apiKey: {
          type: String,
          value: '',
        },

        databaseUrl: {
          type: String,
          value: '',
        },

        authDomain: {
          type: String,
          value: '',
        },

        notifications: {
          type: Array,
          value() { return [] },
        },

        firebaseUser: {
          type: Object,
          value() { return {} },
        },

        me: {
          type: Object,
          value() { return {} },
        },

        signedIn: {
          type: Boolean,
          value: false,
        },

        _firebaseCustomToken: {
          type: String,
        },

        _notificationPath: {
          type: String,
          value: '',
          computed: '_computeNotificationPath(me)'
        },
      },

      observers: [
        'reloadToken(me)',
        '_authApp(_firebaseCustomToken)'
      ],

      _authApp(firebaseCustomToken) {
        if (!firebaseCustomToken || firebaseCustomToken == '') return
        this.$.auth.signInWithCustomToken(firebaseCustomToken).catch(function(error) {
          // Handle Errors here.
          var errorCode = error.code;
          var errorMessage = error.message;
          console.error(error)
        });
      },

      _getDocumentPath(key) {
        return this._notificationPath + '/' + key
      },

      reloadToken() {
        if (!this._firebaseCustomToken || this._firebaseCustomToken == '') return
        App.NotificationSetting.findAll().then((settings) => {
          this._firebaseCustomToken = settings.firebaseCustomToken
        })
      },

      _computeNotificationPath(me) {
        if (!me || !me.id) return
        return '/users/' + me.id + '/notifications'
      }

    });
  </script>
</dom-module>
